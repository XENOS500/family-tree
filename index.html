<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pareek Family Tree</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 100%;
    margin: 0 auto;
}

header {
    text-align: center;
    margin-bottom: 30px;
    color: white;
}

header h1 {
    font-size: 3em;
    font-weight: 700;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    margin-bottom: 10px;
}

.subtitle {
    font-size: 1.3em;
    opacity: 0.9;
    letter-spacing: 1px;
}

.sync-status {
    text-align: center;
    color: white;
    margin-bottom: 15px;
    font-size: 0.9em;
    opacity: 0.8;
}

.sync-status.synced {
    color: #43e97b;
}

.sync-status.syncing {
    color: #ffecd2;
}

.controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    font-size: 1.1em;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.btn-reset {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-expand {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.btn-collapse {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

.btn-add {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
}

.btn-save {
    background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
    color: white;
}

.btn-delete {
    background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
    color: white;
}

.tree-container {
    background: white;
    border-radius: 20px;
    padding: 40px 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow-x: auto;
    min-height: 500px;
}

.save-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    background: rgba(67, 233, 123, 0.9);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 2000;
}

.save-indicator.show {
    opacity: 1;
}

.tree {
    display: inline-block;
    padding: 20px;
    min-width: 100%;
}

.generation {
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: nowrap;
    position: relative;
    margin-bottom: 80px;
}

.family-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    min-width: fit-content;
}

.couple-container {
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
}

.node {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    padding: 5px;
}

.node:hover {
    transform: scale(1.08);
}

.node-image {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    object-fit: cover;
    border: none;
}

.node.male .node-image,
.node.male .placeholder-icon {
    box-shadow: 0 0 15px rgba(74, 144, 226, 0.7), 0 0 30px rgba(74, 144, 226, 0.4);
}

.node.female .node-image,
.node.female .placeholder-icon {
    box-shadow: 0 0 15px rgba(255, 105, 180, 0.7), 0 0 30px rgba(255, 105, 180, 0.4);
}

.node.empty .node-image,
.node.empty .placeholder-icon {
    box-shadow: 0 0 8px rgba(150, 150, 150, 0.3);
    opacity: 0.6;
}

.placeholder-icon {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8em;
    color: #666;
}

.node.male .placeholder-icon {
    background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
    color: white;
}

.node.female .placeholder-icon {
    background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%);
    color: white;
}

.node-name {
    margin-top: 6px;
    font-size: 0.8em;
    font-weight: 600;
    color: #333;
    text-align: center;
    max-width: 70px;
    word-wrap: break-word;
    line-height: 1.1;
}

.connector {
    width: 8px;
    height: 2px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.vertical-line {
    position: absolute;
    width: 2px;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1;
    border-radius: 2px; 
}

.vertical-line-top {
    bottom: calc(100% + 5px);
    height: 45px;
}

.vertical-line-bottom {
    top: calc(100% + 5px);
    height: 40px;
}

.horizontal-connector {
    position: absolute;
    height: 2px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    top: -45px;
    z-index: 0;
}

.expand-btn {
    position: absolute;
    bottom: -55px;
    left: 50%;
    transform: translateX(-50%);
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 10;
}

.expand-btn:hover {
    transform: translateX(-50%) scale(1.15);
}

.hidden {
    display: none !important;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    animation: fadeIn 0.3s ease;
    overflow-y: auto;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover {
    color: #000;
}

.modal-content h2 {
    margin-bottom: 25px;
    color: #333;
    font-size: 1.8em;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
    font-size: 1.1em;
}

.checkbox-label {
    display: flex !important;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 1.1em;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.form-group input[type="text"] {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1.1em;
    transition: border-color 0.3s ease;
}

.form-group input[type="text"]:focus {
    outline: none;
    border-color: #667eea;
}

.form-group input[type="file"] {
    width: 100%;
    padding: 10px;
    font-size: 1em;
}

.image-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    margin-top: 10px;
    border: 3px solid #667eea;
    overflow: hidden;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 25px;
    flex-wrap: wrap;
}

.button-group .btn {
    flex: 1;
    min-width: 100px;
}

.gender-options {
    display: flex;
    gap: 15px;
    margin-top: 8px;
}

.gender-option {
    flex: 1;
    cursor: pointer;
}

.gender-option input[type="radio"] {
    display: none;
}

.gender-label {
    display: block;
    padding: 12px 20px;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 1.1em;
    transition: all 0.3s ease;
    border: 2px solid #ddd;
}

.gender-label.male {
    color: #4A90E2;
    background: rgba(74, 144, 226, 0.1);
}

.gender-label.female {
    color: #FF69B4;
    background: rgba(255, 105, 180, 0.1);
}

.gender-option input[type="radio"]:checked + .gender-label.male {
    background: #4A90E2;
    color: white;
    border-color: #4A90E2;
    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
}

.gender-option input[type="radio"]:checked + .gender-label.female {
    background: #FF69B4;
    color: white;
    border-color: #FF69B4;
    box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
}

.gender-label:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.partner-section {
    padding-top: 20px;
    border-top: 2px solid #eee;
    margin-top: 20px;
}

@media (max-width: 768px) {
    header h1 {
        font-size: 2em;
    }
    
    .subtitle {
        font-size: 1em;
    }
    
    .node-image,
    .placeholder-icon {
        width: 48px;
        height: 48px;
    }
    
    .placeholder-icon {
        font-size: 1.5em;
    }
    
    .node-name {
        font-size: 0.75em;
        max-width: 60px;
    }
    
    .generation {
        gap: 20px;
        margin-bottom: 70px;
    }
    
    .tree-container {
        padding: 30px 15px;
    }
}

@media (max-width: 480px) {
    .node-image,
    .placeholder-icon {
        width: 45px;
        height: 45px;
    }
    
    .placeholder-icon {
        font-size: 1.3em;
    }
    
    .node-name {
        font-size: 0.7em;
        max-width: 55px;
    }
    
    .generation {
        gap: 18px;
    }
}
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">âœ“ Synced to Cloud</div>
    
    <div class="container">
        <header>
            <h1>Pareek Family Tree</h1>
            <p class="subtitle">Tracing the roots of family-by Ayush</p>
            <div class="sync-status" id="syncStatus">ðŸ”„ Connecting to cloud...</div>
        </header>

        <div class="controls">
            <button id="expandAllBtn" class="btn btn-expand">Expand All</button>
            <button id="collapseAllBtn" class="btn btn-collapse">Collapse All</button>
        </div>

        <div id="treeContainer" class="tree-container">
            <div id="tree" class="tree"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Family Member</h2>
            
            <div class="form-group">
                <label for="memberName">Name:</label>
                <input type="text" id="memberName" placeholder="Enter name">
            </div>

            <div class="form-group">
                <label>Gender:</label>
                <div class="gender-options">
                    <label class="gender-option">
                        <input type="radio" name="memberGender" value="male">
                        <span class="gender-label male">â™‚ Male</span>
                    </label>
                    <label class="gender-option">
                        <input type="radio" name="memberGender" value="female">
                        <span class="gender-label female">â™€ Female</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="memberImage">Profile Image:</label>
                <input type="file" id="memberImage" accept="image/*">
                <div id="imagePreview" class="image-preview"></div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="hasPartner">
                    <span>Add Partner?</span>
                </label>
            </div>

            <div id="partnerSection" class="partner-section hidden">
                <div class="form-group">
                    <label for="partnerName">Partner Name:</label>
                    <input type="text" id="partnerName" placeholder="Enter partner's name">
                </div>

                <div class="form-group">
                    <label>Partner Gender:</label>
                    <div class="gender-options">
                        <label class="gender-option">
                            <input type="radio" name="partnerGender" value="male">
                            <span class="gender-label male">â™‚ Male</span>
                        </label>
                        <label class="gender-option">
                            <input type="radio" name="partnerGender" value="female">
                            <span class="gender-label female">â™€ Female</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="partnerImage">Partner Image:</label>
                    <input type="file" id="partnerImage" accept="image/*">
                    <div id="partnerImagePreview" class="image-preview"></div>
                </div>
            </div>

            <div class="button-group">
                <button id="addParentBtn" class="btn btn-add">Add Parent</button>
                <button id="addChildBtn" class="btn btn-add">Add Child</button>
                <button id="saveBtn" class="btn btn-save">Save</button>
                <button id="deleteBtn" class="btn btn-delete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // TODO: Replace with your Firebase config
        // Get this from Firebase Console > Project Settings > Your apps > SDK setup and configuration
        const firebaseConfig = {
  apiKey: "AIzaSyAD-oAt1sp1-z1CyaLkjnx98kxToGX5yOc",
  authDomain: "family-tree-53117.firebaseapp.com",
  databaseURL: "https://family-tree-53117-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "family-tree-53117",
  storageBucket: "family-tree-53117.firebasestorage.app",
  messagingSenderId: "344307172282",
  appId: "1:344307172282:web:34686e24f9a633bfb19383"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const treeRef = ref(database, 'familyTree');

        // Make database globally accessible
        window.firebaseDb = database;
        window.treeRef = treeRef;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        
        // Signal that Firebase is ready
        window.firebaseReady = true;
        if (window.initializeApp) {
            window.initializeApp();
        }
    </script>

    <script>
// Family Tree Data Structure
let familyTree = {
    id: 'root',
    name: 'Click to Add',
    gender: null,
    image: null,
    partner: null,
    partnerGender: null,
    partnerImage: null,
    hasPartner: false,
    children: [],
    expanded: true,
    isEmpty: true
};

let currentEditNode = null;
let nodeIdCounter = 1;
let isLocalUpdate = false;

// DOM Elements
const modal = document.getElementById('editModal');
const closeBtn = document.querySelector('.close');
const memberNameInput = document.getElementById('memberName');
const partnerNameInput = document.getElementById('partnerName');
const memberImageInput = document.getElementById('memberImage');
const partnerImageInput = document.getElementById('partnerImage');
const imagePreview = document.getElementById('imagePreview');
const partnerImagePreview = document.getElementById('partnerImagePreview');
const hasPartnerCheckbox = document.getElementById('hasPartner');
const partnerSection = document.getElementById('partnerSection');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const addParentBtn = document.getElementById('addParentBtn');
const addChildBtn = document.getElementById('addChildBtn');
const expandAllBtn = document.getElementById('expandAllBtn');
const collapseAllBtn = document.getElementById('collapseAllBtn');
const saveIndicator = document.getElementById('saveIndicator');
const syncStatus = document.getElementById('syncStatus');

// Initialize when Firebase is ready
window.initializeApp = function() {
    loadTreeFromFirebase();
    setupRealtimeListener();
};

// If Firebase is already loaded, initialize now
if (window.firebaseReady) {
    window.initializeApp();
}

// Event Listeners
closeBtn.onclick = () => modal.style.display = 'none';
window.onclick = (e) => {
    if (e.target === modal) modal.style.display = 'none';
};

hasPartnerCheckbox.onchange = (e) => {
    partnerSection.classList.toggle('hidden', !e.target.checked);
};

saveBtn.onclick = saveNode;
deleteBtn.onclick = deleteNode;
addParentBtn.onclick = addParent;
addChildBtn.onclick = addChild;
expandAllBtn.onclick = () => expandCollapseAll(true);
collapseAllBtn.onclick = () => expandCollapseAll(false);

memberImageInput.onchange = (e) => handleImagePreview(e, imagePreview);
partnerImageInput.onchange = (e) => handleImagePreview(e, partnerImagePreview);

// Firebase Functions
async function saveTreeToFirebase() {
    try {
        isLocalUpdate = true;
        await window.firebaseSet(window.treeRef, familyTree);
        showSaveIndicator();
        updateSyncStatus('synced');
        setTimeout(() => { isLocalUpdate = false; }, 500);
    } catch (error) {
        console.error('Error saving to Firebase:', error);
        updateSyncStatus('error');
        alert('Error syncing to cloud. Please check your internet connection.');
    }
}

async function loadTreeFromFirebase() {
    try {
        const snapshot = await window.firebaseGet(window.treeRef);
        if (snapshot.exists()) {
            familyTree = snapshot.val();
            renderTree();
            updateSyncStatus('synced');
        } else {
            // No data exists, save initial tree
            await saveTreeToFirebase();
        }
    } catch (error) {
        console.error('Error loading from Firebase:', error);
        updateSyncStatus('error');
    }
}

function setupRealtimeListener() {
    window.firebaseOnValue(window.treeRef, (snapshot) => {
        if (!isLocalUpdate && snapshot.exists()) {
            familyTree = snapshot.val();
            renderTree();
            updateSyncStatus('synced');
        }
    });
}

function updateSyncStatus(status) {
    const statusEl = document.getElementById('syncStatus');
    if (status === 'synced') {
        statusEl.textContent = 'âœ“ Synced with all devices';
        statusEl.className = 'sync-status synced';
    } else if (status === 'syncing') {
        statusEl.textContent = 'ðŸ”„ Syncing...';
        statusEl.className = 'sync-status syncing';
    } else if (status === 'error') {
        statusEl.textContent = 'âš  Sync error - check connection';
        statusEl.className = 'sync-status';
    }
}

function showSaveIndicator() {
    saveIndicator.classList.add('show');
    setTimeout(() => {
        saveIndicator.classList.remove('show');
    }, 2000);
}

// Render Functions
function renderTree() {
    const treeElement = document.getElementById('tree');
    treeElement.innerHTML = '';
    renderNode(familyTree, treeElement, 0);
}

function renderNode(node, parentElement, level) {
    const familyUnit = document.createElement('div');
    familyUnit.className = 'family-unit';
    familyUnit.style.position = 'relative';
    
    if (level > 0) {
        const verticalLineTop = document.createElement('div');
        verticalLineTop.className = 'vertical-line vertical-line-top';
        familyUnit.appendChild(verticalLineTop);
    }
    
    const coupleContainer = document.createElement('div');
    coupleContainer.className = 'couple-container';
    
    const mainNode = createPersonNode(node, false);
    coupleContainer.appendChild(mainNode);
    
    if (node.hasPartner) {
        const connector = document.createElement('div');
        connector.className = 'connector';
        coupleContainer.appendChild(connector);
        
        const partnerNode = createPersonNode(node, true);
        coupleContainer.appendChild(partnerNode);
    }
    
    familyUnit.appendChild(coupleContainer);
    
    if (node.children && node.children.length > 0) {
        const verticalLineBottom = document.createElement('div');
        verticalLineBottom.className = 'vertical-line vertical-line-bottom';
        familyUnit.appendChild(verticalLineBottom);
        
        const expandBtn = document.createElement('button');
        expandBtn.className = 'expand-btn';
        expandBtn.textContent = node.expanded ? 'âˆ’' : '+';
        expandBtn.onclick = (e) => {
            e.stopPropagation();
            toggleExpand(node);
        };
        familyUnit.appendChild(expandBtn);
        
        if (node.expanded) {
            const childrenGeneration = document.createElement('div');
            childrenGeneration.className = 'generation';
            
            node.children.forEach((child) => {
                renderNode(child, childrenGeneration, level + 1);
            });
            
            familyUnit.appendChild(childrenGeneration);
            
            if (node.children.length > 1) {
    requestAnimationFrame(() => {
        addHorizontalConnector(childrenGeneration);
    });
}
        }
    }
    
    parentElement.appendChild(familyUnit);
}

function addHorizontalConnector(generationDiv) {
    const familyUnits = Array.from(generationDiv.children).filter(child => 
        child.classList.contains('family-unit')
    );
    
    if (familyUnits.length < 2) return;
    
    const firstUnit = familyUnits[0];
    const lastUnit = familyUnits[familyUnits.length - 1];
    
    // Get the couple-container (where the actual nodes are) instead of family-unit
    const firstCouple = firstUnit.querySelector('.couple-container');
    const lastCouple = lastUnit.querySelector('.couple-container');
    
    if (!firstCouple || !lastCouple) return;
    
    const parentRect = generationDiv.getBoundingClientRect();
    const firstRect = firstCouple.getBoundingClientRect();
    const lastRect = lastCouple.getBoundingClientRect();
    
    // Calculate center of each couple-container
    const leftPos = firstRect.left - parentRect.left + (firstRect.width / 2);
    const rightPos = lastRect.left - parentRect.left + (lastRect.width / 2);
    const width = rightPos - leftPos;
    
    const horizontalLine = document.createElement('div');
    horizontalLine.className = 'horizontal-connector';
    horizontalLine.style.left = leftPos + 'px';
    horizontalLine.style.width = width + 'px';
    
    generationDiv.appendChild(horizontalLine);
}

function createPersonNode(node, isPartner) {
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'node';
    
    if (isPartner) {
        if (!node.partner) {
            nodeDiv.classList.add('empty');
        }
        if (node.partnerGender) {
            nodeDiv.classList.add(node.partnerGender);
        }
    } else {
        if (node.isEmpty) {
            nodeDiv.classList.add('empty');
        }
        if (node.gender) {
            nodeDiv.classList.add(node.gender);
        }
    }
    
    const imageSource = isPartner ? node.partnerImage : node.image;
    const genderValue = isPartner ? node.partnerGender : node.gender;
    
    if (imageSource) {
        const img = document.createElement('img');
        img.src = imageSource;
        img.className = 'node-image';
        nodeDiv.appendChild(img);
    } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder-icon';
        placeholder.textContent = genderValue === 'male' ? 'â™‚' : genderValue === 'female' ? 'â™€' : 'ðŸ‘¤';
        nodeDiv.appendChild(placeholder);
    }
    
    const name = document.createElement('div');
    name.className = 'node-name';
    if (isPartner) {
        name.textContent = node.partner || 'Add Partner';
    } else {
        name.textContent = node.name || 'Click to Add';
    }
    nodeDiv.appendChild(name);
    
    nodeDiv.onclick = () => openEditModal(node);
    
    return nodeDiv;
}

function openEditModal(node) {
    currentEditNode = node;
    memberNameInput.value = node.name || '';
    partnerNameInput.value = node.partner || '';
    
    const memberGenderRadios = document.querySelectorAll('input[name="memberGender"]');
    memberGenderRadios.forEach(radio => {
        radio.checked = radio.value === node.gender;
    });
    
    const partnerGenderRadios = document.querySelectorAll('input[name="partnerGender"]');
    partnerGenderRadios.forEach(radio => {
        radio.checked = radio.value === node.partnerGender;
    });
    
    hasPartnerCheckbox.checked = node.hasPartner || false;
    partnerSection.classList.toggle('hidden', !hasPartnerCheckbox.checked);
    
    imagePreview.innerHTML = node.image ? `<img src="${node.image}">` : '';
    partnerImagePreview.innerHTML = node.partnerImage ? `<img src="${node.partnerImage}">` : '';
    
    deleteBtn.style.display = node === familyTree ? 'none' : 'block';
    
    modal.style.display = 'block';
}

function saveNode() {
    if (!currentEditNode) return;
    
    const name = memberNameInput.value.trim();
    const partner = partnerNameInput.value.trim();
    
    const memberGender = document.querySelector('input[name="memberGender"]:checked');
    const partnerGender = document.querySelector('input[name="partnerGender"]:checked');
    
    if (name) {
        currentEditNode.name = name;
        currentEditNode.isEmpty = false;
    }
    
    if (memberGender) {
        currentEditNode.gender = memberGender.value;
    }
    
    currentEditNode.hasPartner = hasPartnerCheckbox.checked;
    
    if (hasPartnerCheckbox.checked) {
        if (partner) {
            currentEditNode.partner = partner;
        }
        if (partnerGender) {
            currentEditNode.partnerGender = partnerGender.value;
        }
    } else {
        currentEditNode.partner = null;
        currentEditNode.partnerGender = null;
        currentEditNode.partnerImage = null;
    }
    
    modal.style.display = 'none';
    updateSyncStatus('syncing');
    saveTreeToFirebase();
    renderTree();
}

function deleteNode() {
    if (!currentEditNode || currentEditNode === familyTree) return;
    
    if (confirm('Are you sure you want to delete this family member and all descendants?')) {
        removeNodeFromTree(familyTree, currentEditNode);
        modal.style.display = 'none';
        updateSyncStatus('syncing');
        saveTreeToFirebase();
        renderTree();
    }
}

function removeNodeFromTree(parent, nodeToRemove) {
    if (!parent.children) return false;
    
    const index = parent.children.indexOf(nodeToRemove);
    if (index > -1) {
        parent.children.splice(index, 1);
        return true;
    }
    
    for (let child of parent.children) {
        if (removeNodeFromTree(child, nodeToRemove)) return true;
    }
    
    return false;
}

function addParent() {
    if (!currentEditNode) return;
    
    const newParent = {
        id: 'node_' + nodeIdCounter++,
        name: '',
        gender: null,
        image: null,
        partner: null,
        partnerGender: null,
        partnerImage: null,
        hasPartner: false,
        children: [currentEditNode],
        expanded: true,
        isEmpty: true
    };
    
    if (currentEditNode === familyTree) {
        familyTree = newParent;
    } else {
        replaceNodeInTree(familyTree, currentEditNode, newParent);
    }
    
    modal.style.display = 'none';
    updateSyncStatus('syncing');
    saveTreeToFirebase();
    renderTree();
}

function replaceNodeInTree(parent, oldNode, newNode) {
    if (!parent.children) return false;
    
    const index = parent.children.indexOf(oldNode);
    if (index > -1) {
        parent.children[index] = newNode;
        return true;
    }
    
    for (let child of parent.children) {
        if (replaceNodeInTree(child, oldNode, newNode)) return true;
    }
    
    return false;
}

function addChild() {
    if (!currentEditNode) return;
    
    const newChild = {
        id: 'node_' + nodeIdCounter++,
        name: '',
        gender: null,
        image: null,
        partner: null,
        partnerGender: null,
        partnerImage: null,
        hasPartner: false,
        children: [],
        expanded: true,
        isEmpty: true
    };
    
    if (!currentEditNode.children) {
        currentEditNode.children = [];
    }
    
    currentEditNode.children.push(newChild);
    currentEditNode.expanded = true;
    
    modal.style.display = 'none';
    updateSyncStatus('syncing');
    saveTreeToFirebase();
    renderTree();
}

function toggleExpand(node) {
    node.expanded = !node.expanded;
    updateSyncStatus('syncing');
    saveTreeToFirebase();
    renderTree();
}

function expandCollapseAll(expand) {
    setExpandedRecursive(familyTree, expand);
    updateSyncStatus('syncing');
    saveTreeToFirebase();
    renderTree();
}

function setExpandedRecursive(node, expanded) {
    if (node.children && node.children.length > 0) {
        node.expanded = expanded;
        node.children.forEach(child => setExpandedRecursive(child, expanded));
    }
}



function handleImagePreview(event, previewElement) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewElement.innerHTML = `<img src="${e.target.result}">`;
            
            if (event.target === memberImageInput && currentEditNode) {
                currentEditNode.image = e.target.result;
            } else if (event.target === partnerImageInput && currentEditNode) {
                currentEditNode.partnerImage = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    }
}
    </script>
</body>
</html>
